# 详细请求响应日志功能

## 功能概述

详细请求响应日志功能允许管理员启用详细的API请求和响应记录，用于调试和问题排查。该功能记录完整的请求体、响应体、请求头和响应头信息。

## 功能特性

- **可控制的日志记录**: 通过管理界面的开关控制是否启用详细日志
- **安全过滤**: 自动过滤敏感的请求头信息（如Authorization、Cookie等）
- **性能优化**: 
  - 只对特定的API端点进行日志记录
  - 限制日志大小防止存储过大内容
  - 异步记录日志，不影响请求响应性能
- **完整记录**: 包含用户信息、Token信息、请求响应完整内容

## 启用方式

1. 以管理员身份登录系统
2. 进入 "设置" -> "系统设置" 
3. 找到 "启用详细请求响应日志" 选项
4. 开启该开关并保存设置

## 日志记录范围

该功能只对以下API端点进行详细日志记录：

- `/v1/chat/completions` - 对话补全API
- `/v1/completions` - 文本补全API
- `/v1/embeddings` - 向量嵌入API
- `/v1/images/generations` - 图像生成API
- `/v1/audio/transcriptions` - 音频转录API
- `/v1/audio/translations` - 音频翻译API
- `/v1/responses` - 响应API

## 记录内容

### 基本信息
- 请求路径和方法
- 响应状态码
- 用户ID和用户名
- Token信息（已脱敏）
- 客户端IP地址
- User-Agent信息

### 详细内容
- **RequestBody**: 完整的请求体内容（限制10KB）
- **ResponseBody**: 完整的响应体内容（限制10KB）
- **RequestHeaders**: 请求头信息（已过滤敏感信息）
- **ResponseHeaders**: 响应头信息

### 安全考虑

1. **敏感信息过滤**: 以下请求头会被自动过滤：
   - authorization
   - cookie
   - x-api-key
   - api-key
   - x-forwarded-for
   - x-real-ip

2. **Token脱敏**: API Token只显示前3位和后3位，中间用...替代

3. **大小限制**: 请求体和响应体大小限制为10KB，超出部分会被截断并标记

## 查看日志

详细日志记录在现有的日志系统中，可以通过以下方式查看：

1. 在日志管理界面查看，筛选包含 "详细请求日志" 的记录
2. 通过数据库直接查询 `ChatLogger` 表中 `Metadata` 包含 `"DetailedLogging": "true"` 的记录

## 性能影响

- 启用该功能会增加一定的性能开销
- 日志写入采用异步处理，不会阻塞API响应
- 建议只在需要调试问题时临时启用
- 会增加数据库存储空间使用

## 注意事项

1. 该功能仅对管理员可见和可控制
2. 默认情况下该功能是关闭的
3. 记录的日志包含完整的请求响应内容，请注意隐私和安全
4. 建议定期清理详细日志以节省存储空间
5. 如果系统负载较高，建议谨慎使用该功能

## 故障排除

如果详细日志功能不工作，请检查：

1. 确认管理员权限已正确设置
2. 确认设置已正确保存
3. 检查应用程序日志中是否有相关错误信息
4. 确认数据库连接正常
5. 检查请求的API端点是否在支持的范围内